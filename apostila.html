<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Venda da Apostila - A Percepção do Analista</title>

    <style>
        /* COLE AQUI TODO O CONTEÚDO DO SEU ARQUIVO apostila.style.css */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Poppins', sans-serif; background-color: #0D1B2A; /* ...etc... */ }
        /* ...todo o resto do seu css... */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Poppins', sans-serif; background-color: #0D1B2A; color: #333; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; min-height: 100vh; padding: 2rem 1rem; }
.page-header { text-align: center; margin-bottom: 2rem; }
.logo { max-width: 150px; margin-bottom: 1rem; }
.form-container { background-color: #FFFFFF; padding: 2.5rem; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); width: 100%; max-width: 700px; margin-bottom: 2rem; }
.form-container header { text-align: center; margin-bottom: 2rem; }
.form-container header h1 { font-size: 1.8rem; color: #1E1E1E; font-weight: 700; }
.form-container header p { margin-top: 0.5rem; color: #555; font-size: 1rem; }
.info-box { background-color: #e7f3fe; border-left: 5px solid #3d84e6; padding: 1rem; margin-bottom: 1.5rem; border-radius: 0 8px 8px 0; }
.info-box p { margin: 0; color: #0c5460; font-size: 0.95em; }
.product-display { text-align: center; margin: 2rem 0; padding: 1rem; background-color: #f9f9f9; border-radius: 8px; }
.product-display h2 { font-size: 1.5rem; color: #333; }
.product-display .price { font-size: 1.8rem; font-weight: 700; color: #3d84e6; margin-top: 0.5rem; }
.form-group { margin-bottom: 1.5rem; }
.form-group > label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #444; }
input[type="text"], input[type="email"], input[type="tel"] { width: 100%; padding: 12px; border: 1px solid #DCDCDC; border-radius: 8px; background-color: #F9F9F9; color: #333; font-size: 1rem; transition: all 0.2s; }
input:focus { outline: none; border-color: #3d84e6; box-shadow: 0 0 0 3px rgba(61, 132, 230, 0.25); }
.submit-btn { width: 100%; padding: 15px; border: none; border-radius: 50px; background-image: linear-gradient(to right, #0052D4 0%, #65C7F7 51%, #9CECFB 100%); background-size: 200% auto; color: #FFFFFF; font-size: 1.1rem; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px 0 rgba(65, 132, 234, 0.4); }
.submit-btn:hover { background-position: right center; transform: translateY(-2px); box-shadow: 0 7px 20px 0 rgba(65, 132, 234, 0.5); }
.submit-btn:disabled { background-image: none; background-color: #555; cursor: not-allowed; transform: none; box-shadow: none; }
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; padding: 1rem; }
.modal-content { background-color: #fff; padding: 2rem; border-radius: 12px; text-align: center; width: 100%; max-width: 420px; max-height: 95vh; overflow-y: auto; }
.modal-content h2 { margin-bottom: 1rem; color: #1E1E1E; }
.modal-content p { margin-bottom: 1rem; color: #555; line-height: 1.5; }
.qr-code-img { width: 100%; max-width: 250px; margin: 0 auto 1rem; display: block; border: 1px solid #eee; border-radius: 8px; }
#pix-copy-paste { width: 100%; padding: 10px; font-size: 0.8rem; border: 1px solid #ccc; border-radius: 6px; background-color: #f9f9f9; resize: none; margin-bottom: 1rem; word-break: break-all; }
#copy-button, #close-modal-btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; margin-top: 1rem; }
#copy-button { background-color: #007BFF; color: #fff; }
#copy-button:hover { background-color: #0056b3; }
.waiting-payment { margin-top: 1.5rem; font-weight: 600; color: #f0ad4e; }
#pix-success-message h2 { color: #28a745; }
.success-logo { max-width: 100px; margin-bottom: 1.5rem; }
.confirmation-details { text-align: left; background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 1rem; margin-top: 1.5rem; }
.confirmation-details p { margin: 0.5rem 0; }
.reminder { font-weight: 600; color: #D9534F; }
.help-section { margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #eee; }
.help-section a { color: #007BFF; font-weight: 600; text-decoration: none; }
.help-section a:hover { text-decoration: underline; }
#close-modal-btn { background-color: #6c757d; color: #fff; }
#close-modal-btn:hover { background-color: #5a6268; }
#whatsapp-form { display: flex; gap: 10px; margin-top: 10px; align-items: center; }
#whatsapp-input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; }
#save-whatsapp-btn { padding: 11px 15px; border: none; background-color: #25D366; color: white; font-weight: 600; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; white-space: nowrap; }
#save-whatsapp-btn:hover { background-color: #1DA851; }
#save-whatsapp-btn:disabled { background-color: #aaa; color: #eee; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="page-header"><img src="logo nilson.png" alt="Logo Nilson Santos Terapeuta" class="logo"></div>
    
    <div class="form-container" id="main-container">
        <div id="form-wrapper">
            <header>
                <h1>APOSTILA - MÓDULO I</h1>
                <p>Adquira o material de apoio completo em PDF do módulo "Luto Mal Resolvido".</p>
            </header>
            <form id="purchase-form">
                <div class="info-box">
                    <p><strong>Atenção:</strong> A apostila é um arquivo digital em formato PDF e será enviada para o seu e-mail após a confirmação do pagamento.</p>
                </div>
                <div class="product-display">
                    <h2>Apostila Digital: Luto Mal Resolvido</h2>
                    <p class="price">R$ 19,00</p>
                </div>
                <div class="form-group"><label for="fullName">Nome Completo *</label><input type="text" id="fullName" name="fullName" placeholder="Digite seu nome completo" required></div>
                <div class="form-group"><label for="email">E-mail para Recebimento *</label><input type="email" id="email" name="email" placeholder="seu_email@email.com" required></div>
                <div class="form-group"><label for="cpf">CPF (para o pagamento) *</label><input type="text" id="cpf" name="cpf" placeholder="000.000.000-00" maxlength="14" required></div>
                
                <button type="submit" class="submit-btn" id="submit-button">COMPRAR APOSTILA E PAGAR</button>
            </form>
        </div>
    </div>

    <div id="pix-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div id="pix-payment-info">
                <h2>Pague com PIX para Finalizar</h2>
                <p>Escaneie o QR Code abaixo com o app do seu banco:</p>
                <img id="pix-qrcode-image" src="" alt="QR Code PIX" class="qr-code-img">
                <p>Ou use o PIX Copia e Cola:</p>
                <textarea id="pix-copy-paste" rows="3" readonly></textarea>
                <button id="copy-button">Copiar Código</button>
                <p class="waiting-payment">Aguardando confirmação do pagamento...</p>
            </div>
            <div id="pix-success-message" style="display: none;">
                <img src="logo nilson2.png" alt="Logo" class="success-logo">
                <h2>Pagamento Aprovado!</h2>
                <p>Enviamos a apostila para o seu e-mail: <strong id="user-email-confirm"></strong></p>
                <div class="confirmation-details">
                    <p><strong>Produto:</strong> Apostila Digital - Módulo I</p>
                    <p class="reminder"><strong>IMPORTANTE:</strong> Verifique sua caixa de spam ou lixo eletrônico.</p>
                </div>
                
                <div id="whatsapp-form-container" class="help-section">
                    <p>Para sua segurança, caso não encontre o e-mail, você pode deixar seu WhatsApp abaixo para que nossa equipe possa te ajudar.</p>
                    <form id="whatsapp-form">
                        <input type="tel" id="whatsapp-input" placeholder="(00) 00000-0000" maxlength="15">
                        <button type="submit" id="save-whatsapp-btn">Salvar WhatsApp</button>
                    </form>
                </div>
                
                <div class="help-section">
                    <p>Se preferir, pode também nos contatar pelo e-mail:<br><a href="mailto:nilsonsantosterapeuta@gmail.com"><strong>nilsonsantosterapeuta@gmail.com</strong></a></p>
                </div>
                
                <button id="close-modal-btn">Fechar</button>
            </div>
        </div>
    </div>
    
    <script>
        const form = document.getElementById('purchase-form');
        const submitButton = document.getElementById('submit-button');
        const modal = document.getElementById('pix-modal');
        const qrCodeImage = document.getElementById('pix-qrcode-image');
        const pixCopyPaste = document.getElementById('pix-copy-paste');
        const copyButton = document.getElementById('copy-button');
        const pixPaymentInfo = document.getElementById('pix-payment-info');
        const pixSuccessMessage = document.getElementById('pix-success-message');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const userEmailConfirm = document.getElementById('user-email-confirm');
        const whatsappForm = document.getElementById('whatsapp-form');
        const whatsappInput = document.getElementById('whatsapp-input');
        const saveWhatsappBtn = document.getElementById('save-whatsapp-btn');

        let pollingInterval;
        let formDataForSuccess = {};
        let currentSaleId = null;

        function startPolling(saleId) {
            currentSaleId = saleId; 
            pollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/check-status?saleId=${saleId}`);
                    if (!response.ok) return;
                    const data = await response.json();
                    if (data.status === 'paid') {
                        clearInterval(pollingInterval);
                        userEmailConfirm.textContent = formDataForSuccess.email;
                        pixPaymentInfo.style.display = 'none';
                        pixSuccessMessage.style.display = 'block';
                    }
                } catch (error) { 
                    clearInterval(pollingInterval); 
                }
            }, 5000);
        }

        form.addEventListener('submit', async (event) => {
            event.preventDefault(); 
            submitButton.disabled = true;
            submitButton.textContent = 'Gerando PIX...';
            pixPaymentInfo.style.display = 'block';
            pixSuccessMessage.style.display = 'none';
            const formData = new FormData(form);
            formDataForSuccess = { email: formData.get('email') };
            const data = { 
                fullName: formData.get('fullName'), 
                email: formData.get('email'), 
                cpf: formData.get('cpf')
            };
            try {
                const response = await fetch('/create-payment-apostila', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                if (!response.ok) throw new Error('Falha ao gerar o PIX.');
                const paymentData = await response.json();
                qrCodeImage.src = `data:image/png;base64,${paymentData.qrCodeBase64}`;
                pixCopyPaste.value = paymentData.qrCodeText;
                modal.style.display = 'flex';
                startPolling(paymentData.saleId);
            } catch (error) {
                alert(error.message);
                submitButton.disabled = false;
                submitButton.textContent = 'COMPRAR APOSTILA E PAGAR';
            }
        });

        whatsappForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const whatsappNumber = whatsappInput.value;
            if (!whatsappNumber || !currentSaleId) return;
            
            saveWhatsappBtn.disabled = true;
            saveWhatsappBtn.textContent = 'Salvando...';

            try {
                const response = await fetch('/save-whatsapp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ saleId: currentSaleId, whatsapp: whatsappNumber })
                });
                const result = await response.json();
                if (result.success) {
                    saveWhatsappBtn.textContent = 'Salvo!';
                } else {
                    saveWhatsappBtn.textContent = 'Erro!';
                }
            } catch (error) {
                saveWhatsappBtn.textContent = 'Erro!';
            }
        });

        const cpfInput = document.getElementById('cpf');
        cpfInput.addEventListener('input', (e) => { let v=e.target.value.replace(/\D/g,''); v=v.replace(/(\d{3})(\d)/,'$1.$2'); v=v.replace(/(\d{3})(\d)/,'$1.$2'); v=v.replace(/(\d{3})(\d{1,2})$/,'$1-$2'); e.target.value=v; });

        whatsappInput.addEventListener('input', (e) => { 
            let v=e.target.value.replace(/\D/g,''); 
            v=v.replace(/^(\d{2})(\d)/,'($1) $2'); 
            v=v.replace(/(\d{5})(\d)/,'$1-$2'); 
            e.target.value=v; 
        });

        copyButton.addEventListener('click', () => { pixCopyPaste.select(); document.execCommand('copy'); copyButton.textContent = 'Copiado!'; setTimeout(() => { copyButton.textContent = 'Copiar Código'; }, 2000); });
        
        closeModalBtn.addEventListener('click', () => { 
            modal.style.display = 'none'; 
            clearInterval(pollingInterval); 
            // Reseta o formulário principal ao fechar o modal
            form.reset();
            submitButton.disabled = false;
            submitButton.textContent = 'COMPRAR APOSTILA E PAGAR';
        });
    </script>
</body>
</html>